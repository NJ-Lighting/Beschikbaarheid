<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Beschikbaarheid</title>
  <style>
    :root {
      --bg: #0b0f15;
      --panel: #111827;
      --border: #1f2937;
      --text: #e5e7eb;
      --muted: #94a3b8;
      --busy: #ef4444;
      --busy-border: #dc2626;
      --free: #0b0f15;
      --accent: #1f2937;
    }
    html, body { margin:0; padding:0; background:var(--bg); color:var(--text); font-family: system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji"; }
    #wrap { max-width: 1100px; margin: 24px auto; padding: 0 16px; }
    .toolbar {
      display:flex; gap:8px; align-items:center; justify-content:space-between;
      background:var(--panel); border:1px solid var(--border); border-radius:14px; padding:10px 14px; margin-bottom:12px;
    }
    .left, .right { display:flex; gap:8px; align-items:center; }
    .title { font-weight:700; letter-spacing:.2px; }
    button, select {
      background:var(--accent); color:var(--text); border:1px solid var(--border); border-radius:10px;
      padding:8px 12px; cursor:pointer;
    }
    button:hover, select:hover { filter:brightness(1.1); }
    #view {
      background:var(--panel); border:1px solid var(--border); border-radius:14px; overflow:hidden;
    }
    /* Weekrooster */
    table { width:100%; border-collapse:collapse; table-layout:fixed; }
    th, td { border:1px solid var(--border); text-align:center; }
    th { background: #0c1320; color:var(--text); font-weight:600; padding:10px 6px; }
    td { padding:8px 4px; height:40px; }
    .hour-col { width:80px; color:var(--muted); background:#0d1524; }
    .busy { background: var(--busy); color:#fff; font-weight:700; border-color: var(--busy-border); }
    .free { background: var(--free); }
    .legend { display:flex; gap:14px; align-items:center; color:var(--muted); font-size:14px; margin:10px 2px 16px; }
    .dot { width:14px; height:14px; border-radius:4px; display:inline-block; vertical-align:middle; margin-right:6px; }
    .dot.busy { background:var(--busy); border:1px solid var(--busy-border); }
    .dot.free { background:var(--free); border:1px solid var(--border); }
    /* Maandoverzicht */
    .month-grid { display:grid; grid-template-columns: repeat(7, 1fr); border-top:1px solid var(--border); border-left:1px solid var(--border); }
    .daycell {
      border-right:1px solid var(--border); border-bottom:1px solid var(--border); min-height:110px; position:relative; padding:6px;
      background:#0f172a;
    }
    .daynum { position:absolute; top:6px; right:8px; font-size:12px; color:var(--muted); }
    .daybusy { background: rgba(239,68,68,.18); outline: 1px solid rgba(239,68,68,.35); }
    .outside { opacity:.5; }
    .badge { display:inline-block; padding:3px 6px; border-radius:8px; font-size:12px; margin-top:8px; background:var(--busy); border:1px solid var(--busy-border); color:#fff; font-weight:700; }
    .weekday-header { display:grid; grid-template-columns: repeat(7, 1fr); }
    .weekday-header div { text-align:center; padding:8px 0; background:#0c1320; border-right:1px solid var(--border); border-left:1px solid var(--border); }
    .note { color:var(--muted); font-size:13px; margin:10px 2px; }
  </style>
</head>
<body>
  <div id="wrap">
    <div class="toolbar">
      <div class="left">
        <button id="prevBtn" aria-label="Vorige">&larr;</button>
        <button id="todayBtn">Vandaag</button>
        <button id="nextBtn" aria-label="Volgende">&rarr;</button>
      </div>
      <div class="title" id="title">Beschikbaarheid</div>
      <div class="right">
        <label for="viewSelect" style="color:var(--muted)">Weergave:</label>
        <select id="viewSelect">
          <option value="week">Week</option>
          <option value="month">Maand</option>
        </select>
      </div>
    </div>

    <div class="legend">
      <span><span class="dot busy"></span>Bezet</span>
      <span><span class="dot free"></span>Vrij (geen events)</span>
    </div>

    <div id="view"></div>
    <div class="note">Toont alleen **Bezet**-blokken uit je agenda. Geen titels of details.</div>
  </div>

  <!-- ical.js voor het parsen van ICS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ical.js/1.4.0/ical.min.js"></script>
  <script>
    // === Instellingen ===
    const ICS_URL = "https://api.icalmerge.com/calendar/31794815-9d75-40b9-8883-0399b6c2d949.ics";
    const TIMEZONE = "Europe/Amsterdam";
    const LOCALE = "nl-NL";
    const WEEK_SLOT_START = 7;   // 07:00
    const WEEK_SLOT_END   = 23;  // tot 23:00 (laatste slot start 22:00)

    // CORS fallback: zet op true als je CORS-fout krijgt, of host via je eigen kleine proxy
    const USE_CORS_PROXY = false;
    const CORS_PROXY = "https://cors.isomorphic-git.org/";

    // === State ===
    let rawEvents = []; // lijst van ICAL.Event
    let currentDate = new Date(); // referentiedatum voor navigatie
    let currentView = "week";     // "week" | "month"

    // Helpers
    const fmtMonthTitle = (d) => d.toLocaleDateString(LOCALE, { month: "long", year: "numeric" });
    const fmtWeekTitle = (monday) => {
      const sunday = new Date(monday); sunday.setDate(monday.getDate() + 6);
      const startStr = monday.toLocaleDateString(LOCALE, { day: "numeric", month: "short" });
      const endStr   = sunday.toLocaleDateString(LOCALE, { day: "numeric", month: "short", year: "numeric" });
      return `${startStr} â€“ ${endStr}`;
    };
    const startOfMonday = (d) => {
      const x = new Date(d);
      const day = x.getDay(); // 0 = zondag, 1 = maandag
      const diff = (day === 0 ? -6 : 1 - day);
      x.setDate(x.getDate() + diff);
      x.setHours(0,0,0,0);
      return x;
    };
    const startOfMonth = (d) => { const x = new Date(d); x.setDate(1); x.setHours(0,0,0,0); return x; };

    // Overlap check
    function overlaps(aStart, aEnd, bStart, bEnd) { return aStart < bEnd && aEnd > bStart; }

    // Haal ICS op en parse naar ICAL.Event
    async function loadICS() {
      const url = USE_CORS_PROXY ? (CORS_PROXY + ICS_URL) : ICS_URL;
      const resp = await fetch(url);
      if (!resp.ok) throw new Error("ICS ophalen mislukt: " + resp.status);
      const text = await resp.text();

      const jcalData = ICAL.parse(text);
      const comp = new ICAL.Component(jcalData);
      rawEvents = comp.getAllSubcomponents("vevent").map(e => new ICAL.Event(e));
    }

    // Haal alle voorkomens (incl. herhalingen) in een bereik op als {start:Date,end:Date}
    function getOccurrencesInRange(rangeStart, rangeEnd) {
      const results = [];
      for (const ev of rawEvents) {
        if (ev.isRecurring()) {
          // Herhalende events uitbreiden
          const expand = new ICAL.RecurExpansion({
            component: ev.component,
            dtstart: ev.startDate
          });
          while (!expand.complete) {
            const next = expand.next();
            if (!next) break;
            const occStart = next.toJSDate();
            // Eindtijd = occStart + duur originele event
            const dur = ev.duration;
            const occEnd = dur ? new ICAL.Time(occStart).clone().addDuration(dur).toJSDate()
                               : ev.endDate.toJSDate(); // fallback
            if (occEnd < rangeStart) continue;
            if (occStart > rangeEnd) break; // voorbij bereik
            results.push({ start: occStart, end: occEnd });
          }
        } else {
          const s = ev.startDate.toJSDate();
          const e = ev.endDate.toJSDate();
          if (overlaps(s, e, rangeStart, rangeEnd)) {
            results.push({ start: s, end: e });
          }
        }
      }
      return results;
    }

    // Render weekrooster (uurvakken)
    function renderWeek(dateRef) {
      const viewEl = document.getElementById("view");
      viewEl.innerHTML = "";

      const monday = startOfMonday(dateRef);
      const weekStart = new Date(monday);
      const weekEnd = new Date(monday); weekEnd.setDate(weekEnd.getDate() + 7);

      const occ = getOccurrencesInRange(weekStart, weekEnd);

      // header
      const table = document.createElement("table");
      const thead = document.createElement("thead");
      const thr = document.createElement("tr");

      const thTime = document.createElement("th");
      thTime.textContent = "Tijd";
      thTime.className = "hour-col";
      thr.appendChild(thTime);

      for (let d = 0; d < 7; d++) {
        const day = new Date(monday); day.setDate(monday.getDate() + d);
        const th = document.createElement("th");
        th.textContent = day.toLocaleDateString(LOCALE, { weekday: "long", day: "numeric", month: "short" });
        thr.appendChild(th);
      }
      thead.appendChild(thr);
      table.appendChild(thead);

      const tbody = document.createElement("tbody");
      for (let h = WEEK_SLOT_START; h < WEEK_SLOT_END; h++) {
        const tr = document.createElement("tr");

        const tdHour = document.createElement("td");
        tdHour.className = "hour-col";
        tdHour.textContent = `${String(h).padStart(2,"0")}:00`;
        tr.appendChild(tdHour);

        for (let d = 0; d < 7; d++) {
          const cell = document.createElement("td");
          const slotStart = new Date(monday); slotStart.setDate(monday.getDate() + d); slotStart.setHours(h,0,0,0);
          const slotEnd = new Date(slotStart); slotEnd.setHours(h+1);

          const busy = occ.some(o => overlaps(slotStart, slotEnd, o.start, o.end));
          cell.className = busy ? "busy" : "free";
          cell.textContent = busy ? "Bezet" : "";
          tr.appendChild(cell);
        }
        tbody.appendChild(tr);
      }
      table.appendChild(tbody);
      viewEl.appendChild(table);

      document.getElementById("title").textContent = `Week ${fmtWeekTitle(monday)}`;
    }

    // Render maandoverzicht (dag-blokken)
    function renderMonth(dateRef) {
      const viewEl = document.getElementById("view");
      viewEl.innerHTML = "";

      const first = startOfMonth(dateRef);
      const firstWeekMonday = startOfMonday(first);
      const gridStart = new Date(firstWeekMonday);
      const gridEnd = new Date(gridStart); gridEnd.setDate(gridEnd.getDate() + 42); // 6 weken raster

      const occ = getOccurrencesInRange(gridStart, gridEnd);

      // Weekdagen kop
      const wk = document.createElement("div");
      wk.className = "weekday-header";
      const wds = ["ma", "di", "wo", "do", "vr", "za", "zo"];
      wds.forEach(w => {
        const el = document.createElement("div");
        el.textContent = w.toUpperCase();
        wk.appendChild(el);
      });
      viewEl.appendChild(wk);

      const grid = document.createElement("div");
      grid.className = "month-grid";

      let cursor = new Date(gridStart);
      const thisMonth = first.getMonth();

      for (let i = 0; i < 42; i++) {
        const cell = document.createElement("div");
        cell.className = "daycell";

        const dayStart = new Date(cursor); dayStart.setHours(0,0,0,0);
        const dayEnd = new Date(dayStart); dayEnd.setDate(dayEnd.getDate() + 1);

        const dayNum = document.createElement("div");
        dayNum.className = "daynum";
        dayNum.textContent = String(dayStart.getDate());
        cell.appendChild(dayNum);

        const isBusy = occ.some(o => overlaps(dayStart, dayEnd, o.start, o.end));
        if (isBusy) {
          cell.classList.add("daybusy");
          const badge = document.createElement("div");
          badge.className = "badge";
          badge.textContent = "Bezet";
          cell.appendChild(badge);
        }

        if (cursor.getMonth() !== thisMonth) cell.classList.add("outside");

        grid.appendChild(cell);
        cursor.setDate(cursor.getDate() + 1);
      }

      viewEl.appendChild(grid);
      document.getElementById("title").textContent = fmtMonthTitle(first);
    }

    // Navigatie
    function goPrev() {
      if (currentView === "week") {
        currentDate.setDate(currentDate.getDate() - 7);
        renderWeek(currentDate);
      } else {
        currentDate.setMonth(currentDate.getMonth() - 1);
        renderMonth(currentDate);
      }
    }
    function goNext() {
      if (currentView === "week") {
        currentDate.setDate(currentDate.getDate() + 7);
        renderWeek(currentDate);
      } else {
        currentDate.setMonth(currentDate.getMonth() + 1);
        renderMonth(currentDate);
      }
    }
    function goToday() {
      currentDate = new Date();
      currentView === "week" ? renderWeek(currentDate) : renderMonth(currentDate);
    }

    // Init
    async function init() {
      try {
        await loadICS();
        document.getElementById("viewSelect").addEventListener("change", (e) => {
          currentView = e.target.value;
          currentView === "week" ? renderWeek(currentDate) : renderMonth(currentDate);
        });
        document.getElementById("prevBtn").addEventListener("click", goPrev);
        document.getElementById("nextBtn").addEventListener("click", goNext);
        document.getElementById("todayBtn").addEventListener("click", goToday);

        // Start met weekweergave
        renderWeek(currentDate);
      } catch (err) {
        document.getElementById("view").innerHTML = `<div style="padding:16px;">Kon agenda niet laden: ${err.message}</div>`;
        console.error(err);
      }
    }
    init();
  </script>
</body>
</html>
